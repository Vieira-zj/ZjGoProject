<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <title>webshell xterm demo</title>
    <link rel="stylesheet" type="text/css" href="./dist/xterm.css" />
    <style>
      h1 {
        text-align: center;
      }
      #terminal .terminal.xterm {
        height: 100%;
      }
      #terminal .xterm-viewport {
        height: 100%;
      }
      #terminal {
        height: 100%;
        width: 100%;
        padding: 0%;
        padding-bottom: 5%;
        margin: 0%;
      }
    </style>
  </head>
  <body style="border-width: 0;margin: 0">
    <h2>K8S Web Shell Demo</h2>
    <div id="app">
      <select v-model="nsSelected">
          <option v-for="option in nsOptions" v-bind:value="option.value">
            {{ option.value }}
          </option>
      </select>
      <select v-model="podSelected">
          <option v-for="option in podOptions" v-bind:value="option.value">
            {{ option.value }}
          </option>
      </select>
      <select v-model="containerSelected">
          <option v-for="option in containerOptions" v-bind:value="option.value">
            {{ option.value }}
          </option>
      </select>
      <p>Mamespace [ {{ nsSelected }} ] Pod [ {{ podSelected }} ] Container [ {{ containerSelected }} ]</p>
      <button v-on:click="connect">Connect</button>
    </div>
    <div id="terminal"></div>
    <script src="./dist/xterm.js"></script>
    <script src="./dist/addons/fit/fit.js"></script>
    <script src="./dist/vue.js"></script>
    <script src="./dist/axios.min.js"></script>
    <script src="./terminal.js"></script>
    <!-- <script src="./dist/addons/fullscreen/fullscreen.js"></script> -->
    <!-- <script src="./dist/addons/fullscreen/fullscreen.css"></script> -->
    <script>
      window.onload = function() {
        Terminal.applyAddon(fit)
      }

      const defaultValue = 'None'
      const host = ws_host

      let app = new Vue({
        el: '#app',
        data () {
          return {
            nsSelected: defaultValue,
            podSelected: defaultValue,
            containerSelected: defaultValue,
            nsOptions: [{value: defaultValue}],
            podOptions: [{value: defaultValue}],
            containerOptions: [{value: defaultValue}]
          }
        },
        mounted () {
          let vm = this
          axios
            .get(`http://${host}/query/ns`)
            .then(function(response) {
              let namespaces = response.data.data.namespaces
              if (!Boolean(namespaces)) {
                return
              }
              for (let ns of namespaces) {
                vm.nsOptions.push({value: ns})
              }
            })
            .catch(function(err) {
              console.warn('get cluster namespaces failed:', err)
            })
        },
        methods: {
          connect () {
            console.log('connect to websocket server')
            // Terminal.applyAddon(fullscreen)
            if (this.nsSelected === defaultValue) {
              alert('namespace is not set!')
              return
            }
            if (this.podSelected === defaultValue) {
              alert('pod is not set!')
              return
            }
            if (this.containerSelected === defaultValue) {
              connectWS(this.nsSelected, this.podSelected, false)
              return
            }
            connectWS(this.nsSelected, this.podSelected, this.containerSelected)
          }
        },
        watch: {
          nsSelected: function (newValue, oldValue) {
            let options = [{value: defaultValue}]
            if (newValue === defaultValue) {
              this.podOptions = options
              this.podSelected = defaultValue
              return
            }
            let vm = this
            axios
              .get(`http://${host}/query/pods?ns=${newValue}`)
              .then(function(response) {
                let pods = response.data.data.pods
                if (!Boolean(pods)) {
                  pods = []
                }
                for (let pod of pods) {
                  options.push({value: pod})
                }
                vm.podOptions = options
                vm.podSelected = defaultValue
              })
              .catch(function(err) {
                console.warn(`get namespace [${newValue}] pods failed:`, err)
              })
          },
          podSelected: function (newValue, oldValue) {
            let options = [{value: defaultValue}]
            if (newValue === defaultValue) {
              this.containerOptions = options
              this.containerSelected = defaultValue
              return
            }
            let vm = this
            axios
              .get(`http://${host}/query/containers?ns=${vm.nsSelected}&pod=${newValue}`)
              .then(function(response) {
                let containers = response.data.data.containers
                if (!Boolean(containers)) {
                  containers = []
                }
                for (let container of containers) {
                  options.push({value: container})
                }
                vm.containerOptions = options
                vm.containerSelected = defaultValue
              })
              .catch(function(err) {
                console.warn(`get namespace [${vm.nsSelected}] pod [${newValue}] containers failed:`, err)
              })
          }
        }
      })
    </script>
  </body>
</html>
